<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <title>24ever — Notes</title>

  <link rel="stylesheet" href="/styles.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .note-item{cursor:pointer; border-radius:12px; padding:10px; background:rgba(255,255,255,.7); border:1px solid rgba(0,0,0,.06);}
    .note-item.active{outline:2px solid #ec4899; background:#fff;}
    .note-title{font-weight:600;}
    .note-preview{font-size:.85rem; color:#64748b;}
    textarea{resize:none; overflow:hidden;}
  </style>
</head>
<body class="pb-24">
  <!-- NAVBAR -->
  <nav class="nav fixed top-0 left-0 right-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="brand">24ever</a>
      <button class="hamb" aria-label="Abrir menu" aria-expanded="false"><span></span><span></span><span></span></button>
      <div class="links">
        <a href="/">Home</a>
        <a href="/games">Games</a>
        <a href="/calendar">Calendar</a>
        <a href="/map">Our Map</a>
        <a href="/notes">Notes</a>
        <a href="/links">Links</a>
        <form action="/logout" method="post" class="logout"><button> sair </button></form>
      </div>
    </div>
  </nav>
  <aside id="drawer" class="drawer">
    <div class="drawer-inner">
      <a href="/" class="drawer-link">Home</a>
      <a href="/games" class="drawer-link">Games</a>
      <a href="/calendar" class="drawer-link">Calendar</a>
      <a href="/map" class="drawer-link">Our Map</a>
      <a href="/notes" class="drawer-link">Notes</a>
      <a href="/links" class="drawer-link">Links</a>
      <form action="/logout" method="post"><button class="drawer-link">sair</button></form>
    </div>
  </aside>

  <main class="max-w-6xl mx-auto px-4 pt-24">
    <h1 class="text-2xl font-extrabold mb-4">Notes</h1>

    <div class="grid md:grid-cols-3 gap-4">
      <!-- Lista -->
      <aside class="glass p-3 md:col-span-1">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Suas notas</h2>
          <button id="newNote" class="btn text-sm">Nova nota</button>
        </div>
        <div id="notesList" class="space-y-2" aria-label="Lista de notas"></div>
      </aside>

      <!-- Editor -->
      <section class="glass p-3 md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-gray-500">
            <span id="currentMeta">Nenhuma nota selecionada</span>
          </div>
          <div class="flex gap-2">
            <button id="saveNote" class="btn text-sm" disabled>Salvar</button>
            <button id="deleteNote" class="px-3 py-2 rounded-xl bg-gray-100 text-sm" disabled>Apagar</button>
          </div>
        </div>
        <textarea id="noteText" class="w-full p-3 border rounded-xl min-h-[40svh]" placeholder="Escreve aqui uma notinha pra nós dois..."></textarea>
      </section>
    </div>
  </main>

  <script src="/js/navbar.js"></script>
  <script src="/js/main.js"></script>
  <script>
    const listEl = document.getElementById('notesList');
    const newBtn = document.getElementById('newNote');
    const saveBtn = document.getElementById('saveNote');
    const delBtn  = document.getElementById('deleteNote');
    const textEl  = document.getElementById('noteText');
    const metaEl  = document.getElementById('currentMeta');

    let notes = [];
    let current = null;

    function autoResize(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; }
    textEl.addEventListener('input', autoResize);

    function titleFrom(text){
      const first = (text || '').split('\n')[0].trim();
      return first || '(sem título)';
    }
    function previewFrom(text){
      const lines = (text || '').split('\n');
      const second = lines.slice(1).join(' ').trim();
      return second.length ? second.slice(0, 80) + (second.length > 80 ? '…' : '') : '';
    }

    function renderList(){
      listEl.innerHTML = '';
      notes.forEach(n=>{
        const el = document.createElement('button');
        el.type = 'button';
        el.className = 'note-item w-full text-left ' + (n.id === current ? 'active' : '');
        el.dataset.id = n.id;
        const d = new Date(n.ts);
        el.innerHTML = `
          <div class="note-title">${titleFrom(n.text)}</div>
          <div class="note-preview">${previewFrom(n.text)}</div>
          <div class="text-[11px] text-gray-500 mt-1">${d.toLocaleString()}</div>
        `;
        listEl.appendChild(el);
      });
    }

    function setCurrent(id){
      current = id;
      const n = notes.find(x=>x.id===id);
      if (!n){
        textEl.value = '';
        metaEl.textContent = 'Nenhuma nota selecionada';
        saveBtn.disabled = true; delBtn.disabled = true;
        renderList();
        return;
      }
      textEl.value = n.text || '';
      const d = new Date(n.ts);
      metaEl.textContent = `Editando: ${titleFrom(n.text)} — ${d.toLocaleString()}`;
      saveBtn.disabled = false; delBtn.disabled = false;
      renderList();
      autoResize.call(textEl);
    }

    async function refresh(){
      try {
        const r = await fetch('/api/notes'); 
        notes = await r.json();
        renderList();
        if (notes.length && !current) setCurrent(notes[0].id);
      } catch(e){
        console.warn(e);
      }
    }

    listEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.note-item');
      if (!btn) return;
      setCurrent(btn.dataset.id);
    });

    newBtn.addEventListener('click', async ()=>{
      try{
        const r = await fetch('/api/notes', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: '' })
        });
        const created = await r.json();
        await refresh();
        setCurrent(created.id);
        textEl.focus();
      }catch(e){ console.warn(e); }
    });

    saveBtn.addEventListener('click', async ()=>{
      if (!current) return;
      try{
        const r = await fetch(`/api/notes/${current}`, {
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: textEl.value })
        });
        if (r.ok){
          await refresh();
          setCurrent(current);
        }
      }catch(e){ console.warn(e); }
    });

    delBtn.addEventListener('click', async ()=>{
      if (!current) return;
      if (!confirm('Apagar esta nota?')) return;
      try{
        await fetch(`/api/notes/${current}`, { method:'DELETE' });
        current = null;
        await refresh();
        setCurrent(notes[0]?.id || null);
      }catch(e){ console.warn(e); }
    });

    refresh();
  </script>
</body>
</html>